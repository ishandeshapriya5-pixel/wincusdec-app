<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WinCusdec Pro - Optimized</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f3; margin: 0; padding: 15px; }
        .container { max-width: 1200px; margin: auto; }
        .upload-card { background: white; padding: 25px; border-radius: 15px; text-align: center; border: 3px dashed var(--accent); cursor: pointer; margin-bottom: 15px; }
        .action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
        .btn-clear { background: var(--danger); color: white; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .search-box { flex-grow: 1; padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 15px; min-width: 250px; }
        .table-container { background: white; border-radius: 10px; overflow-x: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { background: var(--primary); color: white; padding: 12px; text-align: left; font-size: 13px; }
        td { padding: 10px 12px; border-bottom: 1px solid #eee; font-size: 12.5px; }
        .badge-duty { background: var(--success); color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
        .btn-del { background: #ffeded; color: var(--danger); border: 1px solid var(--danger); padding: 5px 8px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="upload-card" onclick="document.getElementById('xmlMultiple').click()">
        <h3 style="color: var(--accent); margin: 0;">XML ගොනු මෙතැනට දමන්න</h3>
        <input type="file" id="xmlMultiple" hidden accept=".xml" multiple onchange="handleFiles(this.files)">
    </div>

    <div class="action-bar">
        <input type="text" id="searchInput" class="search-box" placeholder="සොයන්න..." onkeyup="filterData()">
        <button class="btn-clear" onclick="clearDatabase()">සියල්ල මකන්න</button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>වාහනය</th>
                    <th>චැසි අංකය</th>
                    <th>Duty (Rs.)</th>
                    <th>Invoice (JPY)</th>
                    <th>දිනය (Assess)</th>
                    <th>HS Code</th>
                    <th>Rate (LKR)</th>
                    <th>ක්‍රියාව</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    let vehicleDatabase = JSON.parse(localStorage.getItem('vehicleDB')) || [];
    renderTable();

    async function handleFiles(files) {
        for (let file of files) {
            const text = await file.text();
            const parser = new DOMParser();
            const xml = parser.parseFromString(text, "text/xml");

            const getVal = (tags) => {
                for (let tag of tags) {
                    let el = xml.getElementsByTagName(tag)[0];
                    if (el && el.textContent.trim()) return el.textContent.trim();
                }
                return "N/A";
            };

            let date = getVal(["Date", "Assessment_date", "Registration_date"]);

            let rate = getVal(["Currency_rate"]);
            if (rate === "N/A") {
                let nat = xml.getElementsByTagName("Amount_national_currency")[0]?.textContent;
                let forgn = xml.getElementsByTagName("Amount_foreign_currency")[0]?.textContent;
                if (nat && forgn) rate = (parseFloat(nat) / parseFloat(forgn)).toFixed(4);
            }

            let chassis = getVal(["Chassis_Number"]);
            if (chassis === "N/A") {
                let marks = getVal(["Marks1_of_packages"]);
                chassis = marks.includes("CH.NO:") ? marks.split("CH.NO:")[1].trim().split(/[\s,]+/)[0] : "N/A";
            }

            const record = {
                id: Date.now() + Math.random(),
                date: date,
                rate: rate,
                name: getVal(["Description_of_goods"]).split('\n')[0],
                chassis: chassis,
                hs: getVal(["Commodity_code", "HS_Code"]),
                invoice: getVal(["Item_price"]) + " JPY",
                duty: getVal(["Totals_taxes"]),
                searchStr: (date + chassis + rate + getVal(["Description_of_goods"])).toLowerCase()
            };

            if (!vehicleDatabase.some(v => v.chassis === record.chassis && record.chassis !== "N/A")) {
                vehicleDatabase.push(record);
            }
        }
        save();
    }

    function renderTable(data = vehicleDatabase) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = data.map((v, i) => `
            <tr>
                <td>${i + 1}</td>
                <td>${v.name}</td>
                <td><b>${v.chassis}</b></td>
                <td><span class="badge-duty">Rs. ${parseFloat(v.duty).toLocaleString()}</span></td>
                <td>${v.invoice}</td>
                <td>${v.date}</td>
                <td style="color:#e67e22; font-weight:bold;">${v.hs}</td>
                <td>${v.rate}</td>
                <td><button class="btn-del" onclick="deleteItem(${v.id})">මකන්න</button></td>
            </tr>
        `).join('');
    }

    function deleteItem(id) { vehicleDatabase = vehicleDatabase.filter(v => v.id !== id); save(); }
    function clearDatabase() { if(confirm("සියල්ල මකන්නද?")) { vehicleDatabase = []; save(); } }
    function save() { localStorage.setItem('vehicleDB', JSON.stringify(vehicleDatabase)); renderTable(); }
    function filterData() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        renderTable(vehicleDatabase.filter(v => Object.values(v).join(" ").toLowerCase().includes(q)));
    }
</script>
</body>
</html>
