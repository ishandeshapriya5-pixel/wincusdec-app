// මෙය ඔබගේ handleFiles ශ්‍රිතය (Function) තුළ ඇති processFile කොටසට ආදේශ කරන්න

const parser = new DOMParser();
const xml = parser.parseFromString(e.target.result, "text/xml");

// දත්ත ලබාගැනීමේ ක්‍රමය ශක්තිමත් කිරීම
const getVal = (path) => {
    let node = xml;
    for (let part of path.split('>')) {
        node = node.getElementsByTagName(part)[0];
        if (!node) return "N/A";
    }
    return node.textContent.trim() || "N/A";
};

// 1. දිනය ලබාගැනීම (විවිධ ක්‍රම පරීක්ෂා කරයි)
let assessDate = getVal("Assessment_date");
if (assessDate === "N/A") assessDate = getVal("Assessment>Date");
if (assessDate === "N/A") assessDate = getVal("Registration>Date");

// 2. Exchange Rate ලබාගැනීම (විවිධ ක්‍රම පරීක්ෂා කරයි)
let exchangeRate = getVal("Currency_rate");
if (exchangeRate === "N/A") {
    // විකල්ප ක්‍රමය: National / Foreign අනුපාතිකය ගණනය කිරීම
    const nat = parseFloat(getVal("Gs_Invoice>Amount_national_currency"));
    const forgn = parseFloat(getVal("Gs_Invoice>Amount_foreign_currency"));
    if (nat && forgn) exchangeRate = (nat / forgn).toFixed(4);
}

// 3. HS Code ලබාගැනීම
let hs = getVal("Commodity_code");
if (hs === "N/A") hs = getVal("HS_Code");

// 4. වාහනය සහ චැසිය
const name = getVal("Description_of_goods").split('\n')[0];
let chassis = getVal("Chassis_Number");
if (chassis === "N/A") {
    const marks = getVal("Marks1_of_packages") || "";
    chassis = marks.includes("CH.NO:") ? marks.split("CH.NO:")[1].trim().split(" ")[0] : "N/A";
}

// 5. මුදල් වර්ග
const dutyAmount = getVal("Totals_taxes");
const dutyFormatted = dutyAmount !== "N/A" ? "Rs. " + parseFloat(dutyAmount).toLocaleString('en-US') : "N/A";
